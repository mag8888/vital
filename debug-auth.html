<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auth - –≠–Ω–µ—Ä–≥–∏—è –¥–µ–Ω–µ–≥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .debug-section {
            background: #2a2a3e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        button {
            background: #4c6ef5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #364fc7; }
        pre { background: #000; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Auth - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1>
    
    <div class="debug-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage</h3>
        <div id="localStorageInfo"></div>
        <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
    </div>
    
    <div class="debug-section">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API</h3>
        <div id="apiInfo"></div>
        <button onclick="checkAPI()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
    </div>
    
    <div class="debug-section">
        <h3>3. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
        <div id="authTest"></div>
        <button onclick="testAuth()">–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
    </div>
    
    <div class="debug-section">
        <h3>4. –¢–µ—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <div id="profileTest"></div>
        <button onclick="testProfile()">–¢–µ—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è</button>
    </div>
    
    <div class="debug-section">
        <h3>5. –¢–µ—Å—Ç –∫–æ–º–Ω–∞—Ç</h3>
        <div id="roomsTest"></div>
        <button onclick="testRooms()">–¢–µ—Å—Ç –∫–æ–º–Ω–∞—Ç</button>
    </div>

    <script src="assets/js/modules/api/RoomApi.js"></script>
    <script>
        let api = null;
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        function checkLocalStorage() {
            clearLog('localStorageInfo');
            const authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            log('localStorageInfo', `Auth Token: ${authToken ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}`, authToken ? 'success' : 'error');
            log('localStorageInfo', `User: ${user ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}`, user ? 'success' : 'error');
            
            if (authToken) {
                log('localStorageInfo', `Token preview: ${authToken.substring(0, 20)}...`);
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log('localStorageInfo', `User ID: ${userData.id || '–ù–µ—Ç ID'}`);
                    log('localStorageInfo', `User Name: ${userData.first_name || '–ù–µ—Ç –∏–º–µ–Ω–∏'} ${userData.last_name || ''}`);
                } catch (e) {
                    log('localStorageInfo', `–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ user: ${e.message}`, 'error');
                }
            }
            
            log('localStorageInfo', `–í—Å–µ –∫–ª—é—á–∏: ${Object.keys(localStorage).join(', ')}`);
        }
        
        function checkAPI() {
            clearLog('apiInfo');
            
            log('apiInfo', `RoomApi –¥–æ—Å—Ç—É–ø–µ–Ω: ${window.RoomApi ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`, window.RoomApi ? 'success' : 'error');
            
            if (window.RoomApi) {
                try {
                    api = new window.RoomApi();
                    log('apiInfo', `API —Å–æ–∑–¥–∞–Ω: ‚úÖ`, 'success');
                    log('apiInfo', `Base URL: ${api.baseUrl}`);
                } catch (e) {
                    log('apiInfo', `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è API: ${e.message}`, 'error');
                }
            }
        }
        
        async function testAuth() {
            clearLog('authTest');
            
            const email = 'test@example.com';
            const password = 'test123';
            
            try {
                log('authTest', `–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: ${email}`);
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('authTest', `–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!`, 'success');
                    log('authTest', `Token: ${data.accessToken.substring(0, 20)}...`);
                    log('authTest', `User ID: ${data.user.id}`);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    localStorage.setItem('authToken', data.accessToken);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    log('authTest', `–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage`, 'success');
                } else {
                    log('authTest', `–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.message}`, 'error');
                }
            } catch (e) {
                log('authTest', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error');
            }
        }
        
        async function testProfile() {
            clearLog('profileTest');
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                log('profileTest', '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                return;
            }
            
            try {
                log('profileTest', `–ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è —Å —Ç–æ–∫–µ–Ω–æ–º: ${token.substring(0, 20)}...`);
                
                const response = await fetch('/api/user/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('profileTest', `–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–µ–Ω!`, 'success');
                    log('profileTest', `User ID: ${data.id}`);
                    log('profileTest', `Name: ${data.first_name} ${data.last_name}`);
                } else {
                    const error = await response.text();
                    log('profileTest', `–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: ${response.status} - ${error}`, 'error');
                }
            } catch (e) {
                log('profileTest', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error');
            }
        }
        
        async function testRooms() {
            clearLog('roomsTest');
            
            if (!api) {
                log('roomsTest', 'API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            try {
                log('roomsTest', `–ó–∞–ø—Ä–æ—Å –∫–æ–º–Ω–∞—Ç —á–µ—Ä–µ–∑ API...`);
                const result = await api.listRooms();
                log('roomsTest', `–ö–æ–º–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã!`, 'success');
                log('roomsTest', `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç: ${Array.isArray(result) ? result.length : '–ù–µ –º–∞—Å—Å–∏–≤'}`);
                log('roomsTest', `<pre>${JSON.stringify(result, null, 2)}</pre>`);
            } catch (e) {
                log('roomsTest', `–û—à–∏–±–∫–∞ –∫–æ–º–Ω–∞—Ç: ${e.message}`, 'error');
                log('roomsTest', `Stack: ${e.stack}`);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkLocalStorage();
            checkAPI();
        });
    </script>
</body>
</html>
