# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –±–æ–Ω—É—Å–∞—Ö

## üêõ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ **3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å—á–µ—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞, —Ö–æ—Ç—è –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ.

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:
```
üéâ –í–∞—à —Å—á–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ —Å—É–º–º—É 6.00 PZ (5%) –æ—Ç –ø–æ–∫—É–ø–∫–∏ –≤–∞—à–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞! [14:33]
üéâ –í–∞—à —Å—á–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ —Å—É–º–º—É 6.00 PZ (5%) –æ—Ç –ø–æ–∫—É–ø–∫–∏ –≤–∞—à–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞! [14:33]  
üéâ –í–∞—à —Å—á–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ —Å—É–º–º—É 6.00 PZ (5%) –æ—Ç –ø–æ–∫—É–ø–∫–∏ –≤–∞—à–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞! [14:34]
```

## üîç –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ **–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤** —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∫–æ–¥–∞:

1. **–í `admin/orders-module.ts`** (—Å—Ç—Ä–æ–∫–∞ 660) - –≤—ã–∑—ã–≤–∞–ª–∞—Å—å `distributeReferralBonuses`
2. **–í `admin/web.ts`** (—Å—Ç—Ä–æ–∫–∞ 8165) - –≤—ã–∑—ã–≤–∞–ª–∞—Å—å `calculateDualSystemBonuses`

–û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –°–æ–∑–¥–∞–≤–∞–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –ù–∞—á–∏—Å–ª—è–ª–∏ –±–æ–Ω—É—Å—ã

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤
- ‚úÖ –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤—ã–∑–æ–≤ `calculateDualSystemBonuses` –≤ `admin/web.ts`
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ –≤ `orders-module.ts`

### 2. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞
- ‚úÖ `orders-module.ts` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `calculateDualSystemBonuses` –∏–∑ `partner-service.ts`
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `distributeReferralBonuses` –∏–∑ `orders-module.ts`

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `calculateDualSystemBonuses` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –±—ã–ª–∏ –ª–∏ —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –±–æ–Ω—É—Å—ã –∑–∞ –∑–∞–∫–∞–∑
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `orderId` –≤ payload –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏

### 4. –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤

## üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### `src/admin/web.ts`
```typescript
// –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤
/*
try {
  await calculateDualSystemBonuses(order.user.id, totalAmount);
} catch (bonusError) {
  console.error('‚ùå Referral bonus distribution error:', bonusError);
}
*/
```

### `src/admin/orders-module.ts`
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ partner-service.ts
try {
  const { calculateDualSystemBonuses } = await import('../services/partner-service.js');
  await calculateDualSystemBonuses(order.userId || '', totalAmount, orderId);
} catch (bonusError) {
  console.error('‚ùå Referral bonus distribution error:', bonusError);
}
```

### `src/services/partner-service.ts`
```typescript
export async function calculateDualSystemBonuses(orderUserId: string, orderAmount: number, orderId?: string) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
  if (orderId) {
    const existingBonuses = await prisma.userHistory.findMany({
      where: {
        userId: orderUserId,
        action: 'REFERRAL_BONUS'
      }
    });
    
    const hasExistingBonus = existingBonuses.some(bonus => {
      const payload = bonus.payload as any;
      return payload && payload.orderId === orderId;
    });
    
    if (hasExistingBonus) {
      console.log(`‚ö†Ô∏è Bonuses already distributed for order ${orderId}, skipping...`);
      return [];
    }
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
}
```

## üßπ –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–µ–π

–°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

### 1. –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π
```bash
node scripts/cleanup-duplicate-bonuses.js
```

### 2. –ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤
```bash
node scripts/recalculate-balances-after-cleanup.js
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **–¢–µ–ø–µ—Ä—å –∑–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–Ω—É—Å–µ**
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤**
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã**
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞**

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –±–æ–Ω—É—Å–∞—Ö
3. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å** –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã**: –õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- **–í–ª–∏—è–Ω–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –°—Ä–µ–¥–Ω—è—è
- **–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ~2 —á–∞—Å–∞
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ production

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: $(date)  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
